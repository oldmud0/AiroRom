% Copyright (c) 2015 Benito Palacios Sánchez - All Rights Reserved.
% Esta obra está licenciada bajo la Licencia Creative Commons Atribución 4.0
% Internacional. Para ver una copia de esta licencia, visita
% http://creativecommons.org/licenses/by/4.0/.

\chapter{Traducciones no oficiales}
\label{sec:translations}
% Traduccion -> parche -> legalidad -> evolución en sagas. Mods. Resultados.

Las traducciones no oficiales, conocidas informalmente como  \textit{fan-traducciones}~\cite{Wiki-Trans}, son trabajos realizados por personas externas a la compañía desarrolladora.
Su objetivo es traducir un videojuego y compartirlo de forma altruista.
La distribución se hace comúnmente en foros dedicados y mediante \textit{parches}, es decir, archivos binarios que contienen solo las modificaciones realizadas y en principio, no contenido con derechos de autor.
Este capítulo se ha centrado en los resultados obtenidos al analizar juegos principalmente de la consola \acl{NDS}.
La selección se ha realizado en base a sagas que han tenido más traducciones no oficiales (\textit{Pokémon}), juegos con proyectos largos de traducción (\textit{Ninokuni}) y aquellos en los que se han visto solicitudes o intentos  (\textit{London Life} y demás).

Este tipo de trabajos se remontan al origen de los ordenadores cuando, en 1993 se forma el primer grupo de traducción llamado Oasis para MSX~\cite{HarCod-RH}.
A partir de entonces, numerosos proyectos han surgido con dos páginas webs como referencia: GbaTemp.net\footnote{\url{http://gbatemp.net/}} y ROMHacking.net\footnote{\url{http://www.romhacking.net/}}.
El motivo para iniciar un proyecto es la confirmación por parte de una empresa de que no se llevaría a cabo la traducción del juego.
Como se explica en el último apartado, a pesar de ello han existido casos en los que la traducción se ha iniciado antes de dicha confirmación y tras producirse esta, esos proyectos se detuvieron.
No ha sucedido así con todos los juegos, pues en la saga de \textit{Pokémon}, han existido traducciones parciales antes de la oficial, perjudicando las ventas de la compañía, pues los usuarios prefieren obtener una copia no lícita del juego antes de esperar a la salida oficial.
Es en estos juegos donde, como se ha analizado en la siguiente sección, se observa una evolución de mecanismos para evitar y retrasar estos trabajos.

Estos hechos se han visto reflejados recientemente en dos cartas de \textit{cese y desista} enviadas por la empresa \textit{Square Enix} a los grupos de traducción de \textit{Final Fantasy Type-0}~\cite{VG247-FF0} para \ac{PSP} y \textit{Dragon Quest VII}~\cite{Reddit-DQ7} para \acl{N3DS}.
En ellas se alega que por `motivos de mercado' no pueden permitir esos trabajos, refiriéndose a la salida de estos títulos para otras consolas.
En ambos casos, los grupos de traducción pararon la traducción.

Relacionado con las traducciones, se encuentran los \textit{mods}~\cite{Wiki-Mods}, modificaciones sobre un videojuego con el objetivo de crear una versión alternativa.
Usando el motor del juego, se cambia historia, imágenes, sonidos y \textit{scripts}.
Existen comunidades dedicadas exclusivamente a este motivo como es \textit{Whack a Hack!}\footnote{\url{http://wahackpokemon.com/es}} para la saga \textit{Pokémon}.

Los mecanismos que se van a comentar a continuación, muestran como son los archivos con contenido de texto e imágenes son los más protegidos u ofuscados.
Esto no evita en su totalidad la edición pues, teniendo acceso al código máquina que ejecuta la consola, se puede mirar cómo accede a los ficheros.
Sin embargo, sí puede retrasar o al menos imposibilitar para aquellas personas que no tengan los conocimientos técnicos necesarios.

\section{Saga Pokémon en Nintendo DS}
\label{sec:tr-pok}
\textit{Pokémon} es una serie de juegos desarrollados por \textit{Game Freak} desde 1993 para las consolas de Nintendo.
La saga se divide en denominadas `generaciones' que engloban al menos tres juegos.
Ha sido una de las franquicias más exitosas a nivel mundial~\cite{GamSpo-GF} y cuenta con una serie de animación y películas entre otros.

A causa de la fama de los juegos y la falta de paciencia de los seguidores, se desarrollan traducciones parciales del juego.
Estos proyectos, comenzados pocas horas después del primer lanzamiento en Japón, pretenden ofrecer una versión parcialmente traducida en semanas, adelantándose a los lanzamientos oficiales.
Este es el caso de comunidades como PokéCheats.net\footnote{\url{http://pokecheats.net/tools/translations.php}} o ProjectPokemon.org\footnote{\url{http://projectpokemon.org/}}.

Es por estos motivos, que \textit{Game Freak} desde el primer juego de \acl{NDS} incluyó métodos de ofuscación, con el objeto de no solo evitar traducciones, si no también los \textit{mods}.
Dado que no se puede evitar conocer qué algoritmos protegen a los archivos ya que se puede mirar qué instrucciones máquinas ejecuta la consola para realiza esa misma tarea, el objetivo es retrasar y dificultar, para que se requieren conocimientos técnicos y esfuerzo para realizar dicha tarea.

Los textos que aparecen en diálogos y menús, al igual que las imágenes principales de \textit{Pokémons}, son el primer objetivo a la hora de realizar una traducción o edición.
Estos han sido el objeto de estudio y donde se han encontrado los algoritmos de protección que se analizarán en los siguientes subapartados.
Además se ha podido comprobar una evolución de estas técnicas a lo largo de las generaciones.

Los sonidos y música han sido los únicos archivos que no han estado protegidos.
Se encuentran en un formato y codificación estándar con extensión \texttt{sdat} en la carpeta raíz del juego.

\subsection{Pokémon Perla y Diamante}
\label{sec:tr-pok-pearl}
Los juegos \textit{Pokémon Diamante y Perla} corresponden a la cuarta generación de saga y a la primera que salió para \acl{NDS}.
Primero llegó a Japón en septiembre de 2006, siete meses después a los Estados Unidos y tres meses más a Europa.

\subsubsection{Archivos}
\label{sec:tr-pok-pearl-file}
Una de las características de la \acl{NDS} respecto a su antecesora (\acl{GBA}) es la introducción del sistema de ficheros.
Dentro los juegos existe una sección para indicar cómo dividir los datos del juego en ficheros y a su vez estos en carpetas con nombres.
Esto ha facilitado la tarea de investigación ya que en la mayoría de los juegos, los archivos tienen nombres descriptivos sobre su contenido.

Es el caso de esta generación, donde como se ha visto (figura~\ref{fig:tr-pearlfiles}) la jerarquía de carpetas y aun más el nombre de los archivos ofrecen claras pistas de su contenido.
Por ejemplo, en \texttt{msgdata/msg.narc} se ha encontrado los textos del juego, en \texttt{itemtool/itemdata/item\_icon.narc} las imágenes de los objetos y en \texttt{graphic/font.narc} las tipografías del juego.

\includefigure{fig:tr-pearlfiles}{Sistema de ficheros en Pokémon Perla visto con Tinke}{imgs/TR-PearlFiles.png}

\subsubsection{Textos}
\label{sec:tr-pok-pearl-text}

Respecto a los textos, tras aplicar la metodología de la sección~\ref{sec:met-search-tex} se ha visto que estaban cifrados, además de usar una codificación no estándar que dificultó la investigación.
Para usar el primer método descrito, se ha buscado y estudiado la fuente del juego para determinar la codificación, se muestra en la tabla~\ref{tab:tr-pearlfont}.
% TODO: Crear plugin de Tinke para exportarla.
% TODO: Añadir imagen de la tipografía extraída.

\ctable[
    mincapwidth = 110 mm,
    footerwidth,
    caption = Especificación de tipografías en Pokémon Perla,
    label   = tab:tr-pearlfont,
    pos     = h
]{ccl}{
    \tnote[a]{Los caracteres están codificados por \textit{tiles} de 8$\times$8 píxeles en formato horizontal.}
    \tnote[b]{Cada byte indica el ancho del carácter.}
}{                                                                      \FL
    Posición      & Tamaño        & Descripción                         \ML
    \multicolumn{3}{c}{Cabecera}                                        \NN
    \texttt{0x00} & \texttt{0x04} & Puntero a la sección de datos       \NN
    \texttt{0x04} & \texttt{0x04} & Puntero a la sección \acs{VWT}      \NN
    \texttt{0x08} & \texttt{0x04} & Número de caracteres                \NN
    \texttt{0x0C} & \texttt{0x01} & Ancho de un caracter                \NN
    \texttt{0x0D} & \texttt{0x01} & Alto de un caracter                 \NN
    \texttt{0x0E} & \texttt{0x01} & BPP                                 \NN
    \texttt{0x0F} & \texttt{0x01} & BPP                                 \ML
    \multicolumn{3}{c}{Datos de la fuente\tmark[a]}                     \ML
    \multicolumn{3}{c}{\ac{VWT}\tmark[b]}                               \LL
}

El algoritmo es un cifrado con operación \texttt{XOR} y clave dinámica aplicado sobre cada byte individualmente.
La clave inicial es igual a \verb!clave = (ushort)(0x91BD3 * (i + 1))! donde \verb!i! es el bloque de texto a descifrar.
Después de descifrar un byte se actualiza según \verb!clave = (ushort)(clave + 0x493D)!.

El cifrado se ha aplicado también sobre los campos de la tabla de contenidos (ver tabla~\ref{tab:tr-pearltxt}).
Se usa la misma clave de 16 bits, concatenada dos veces, para aplicarla sobre los valores de 32 bits \textit{posición} y \textit{tamaño} de una misma entrada.
Se inicializa con: \verb!clave = (ushort)(clave_base * 0x2FD * (i + 1))! donde \verb!i! es el número de la entrada a descifrar.
Como se ve, se hace uso de una \textit{clave base} que se encuentra disponible en la cabecera del fichero.

Sin embargo, esta parte del fichero presenta un fallo de seguridad pues se está guardando la clave en texto plano.
Como se ha comentado los valores cifrados son de 32 bits (4 bytes) pero en el caso del campo \textit{posición}, en la mayoría de las veces \textbf{solo se usan los dos primeros bytes} pues, como el tamaño del fichero de texto no supera los \verb!2^16 = 65535 bytes!, no hace falta posiciones más grande de estas.
Esto ocurre también sobre el campo \textit{tamaño} donde se aplica la misma clave, ya que \textbf{en pocas ocasiones un diálogo ocupará más de 65 KB.}
Debido a que la clave se concatena para descifrar el valor de 32 bits, se está aplicando sobre bytes con valor 0, quedando la clave almacenada en texto plano.
\verb!valor_cifrado = (00 00 AB CD) XOR (XW YZ XW YZ) = (XW YZ EF GH)! siendo \verb!00 00 AB CD! el campo descifrado y \verb!XW YZ! la clave.

En la tabla~\ref{tab:tr-pearltxt} se especifica el formato de los archivos de texto.

\ctable[
    mincapwidth = 110 mm,
    footerwidth,
    caption = Especificación del formato de texto en Pokémon Perla,
    label   = tab:tr-pearltxt,
    pos     = h,
]{ccl}{
    \tnote[a]{Se especifica solo la primera entrada.}
    \tnote[b]{Campo cifrado descrito en la sección~\ref{sec:tr-pok-pearl-text}.}
}{                                                                      \FL
    Posición      & Tamaño        & Descripción                         \ML
    \multicolumn{3}{c}{Cabecera}                                        \NN
    \texttt{0x00} & \texttt{0x02} & Número de bloques de texto          \NN
    \texttt{0x02} & \texttt{0x02} & Clave base para descifrar \acs{TOC} \ML
    \multicolumn{3}{c}{\acl{TOC}\tmark[a]}                              \NN
    \texttt{0x00} & \texttt{0x04} & Posición del texto\tmark[b]         \NN
    \texttt{0x04} & \texttt{0x08} & Tamaño del texto\tmark[b]           \ML
    \multicolumn{3}{c}{Texto\tmark[b]}                                  \LL
}

\subsubsection{Imágenes}
\label{sec:tr-pok-pearl-img}
En este juego las imágenes no contienen texto por lo que no son necesarias editarlas en una traducción.
Sin embargo, si son objetivo de los \textit{mods} y de extraerlas para compartirlas.
Es por ello que se ha podido ver como las imágenes del archivo \texttt{poketool/pokegra/pokegra.narc}, que contiene seis \textit{sprites} por \textit{Pokémon} usados durantes las batalla, están cifradas.

El cifrado se realizó sobre los datos de la imagen, manteniendo las cabeceras del formato intacto.
Como consecuencia, las imágenes se podían abrir pero no ver usando programas estándar.
% TODO: Hacer programa y descifrar una imagen y poner comparativa

Aplicando la metodología descrita en la sección~\ref{sec:met-search-img} se pudo encontrar el algoritmo.
Usando bloques de datos con tamaño fijo de \texttt{0x1900} bytes, aplicar la operación \texttt{XOR} sobre valores de 16 bits comenzando por el final.
La clave es de 32 bits y se actualiza después de usarse.
Se inicializa con el primer valor cifrado, últimos dos bytes del fichero, e irá cambiando según \verb!clave = (uint)(clave * 0x41C64E6D + 0x6073)!.

\subsubsection{Conclusión}

\begin{tabular}{p{0.4\textwidth}p{0.5\textwidth}}
Puntos fuertes & Puntos débiles \\
% Pros
\begin{itemize}
\item Los textos usando una codificación no estándar.
\item Los textos están cifrados con una clave dinámica.
\item Las imágenes están cifradas con un clave dinámica.
\end{itemize} &

% Contras
\begin{itemize}
\item Los archivos y carpetas tienen nombres descriptivos.
\item Hay un fallo de seguridad en el cifrado de la tabla de contenido de los textos por el que se puede averiguar la clave.
\item Las imágenes usan codificaciones estándar por lo que el \textit{software} existen de procesamiento se puede utilizar una vez descifrado el fichero.
\end{itemize} \\
\end{tabular}

\subsection{Pokémon HeartGold y SoulSilver}
Los juegos \textit{Pokémon HeartGold y SoulSilver} son las siguiente generación de la saga que salieron también para \acl{NDS}.
Se repite como es común el orden y plazo de lanzamiento. De esta forma se lanzó primero en Japón a mediados de septiembre de 2009, a continuación en América seis meses después, en abril de 2010, y finalmente en Europa una semana después.

Esta vez no hubo mucha diferencia entre los lanzamientos de América y Europa lo que provocaría que no fuese necesario realizar traducciones no oficiales desde el inglés, idioma desde el cual al ser más sencillo se parten la mayoría de las traducciones.
Sin embargo, sí hubo traducciones que partieron del japonés y que se quedaron entorno a un 90\% de finalización~\cite{PokProj-HG1}.

\subsubsection{Archivos}
\label{sec:tr-pok-heart-file}
La primera gran diferencia en esta generación llega con el ofuscado de nombres de archivos y directorios. Como se puede apreciar en la figura~\ref{fig:tr-heartfiles} todos los archivos principales del juego están nombrados con números y clasificados en carpetas numéricas también.
Además, el contenido de estas carpetas no relaciona a los archivos entre sí generando una organización aleatoria.
En total hay 275 archivos que a su vez son contenedores de subarchivos sin nombre.
Estos contenedores pueden llegar a tener más de 1000 archivos en su interior pero si se garantiza que el contenido de estos está relacionado entre si correspondiendo a las imágenes a las características de \textit{Pokémon} o las imágenes de un menú concreto.

\includefigure{fig:tr-heartfiles}{Carpetas y ficheros ofuscados en Pokémon HeartGold}{imgs/TR-HeartFiles.png}

Mediante depuración del código ensamblador se pudo comprobar la implementación del acceso a estos archivos.
Todo se realiza llamando a varias funciones de similar cometido cuyo primer parámetro es un ID que identifica al archivo y como segundo parámetro el sub-archivos dentro del contenedor.
Este ID es lineal y si se descompone en base diez se puede calcular la ruta absoluta.
De esta forma el ID \texttt{0x1B} (27) corresponde a \texttt{27 = 0*10 + 2*10 + 7} lo que significa que estaría ubicado en \textit{a/0/2/7}.
A la hora de implementar este mecanismo durante el desarrollo del videojuego se usuaría un archivo de cabeceras similar al siguiente.

\begin{verbatim}
file_paths.h
#define MESSAGE_FILE_ID 0x1B
#define POKEMON_IMAGES_FILE_ID 0x1C
\end{verbatim}

De esta manera, en el proceso de desarrollo sería fácil y sin ofuscar su propio código el indicar qué fichero cargar usando las constantes definidas.
Este método es sencillo de implementar y dificulta la tarea de edición del juego pues entre los 275 archivos disponibles, binarios, sin estructuras de datos conocidas, habría que averiguar qué hace cada uno sin tener una pista previa como pasaba en ediciones anteriores donde el nombre era descriptivo del contenido.

\subsubsection{Textos}
Los textos de esta generación vienen igualmente cifrados.
Esto se pudo comprobar al realizar de nuevo una búsqueda de palabras de los primeros diálogos y no tener resultados ni en el archivo binario del juego ni sobre la memoria RAM.

Tras repetir el proceso descrito en la sección~\ref{sec:tr-pok-pearl-text} de textos de la generación anterior, se comprobó que tanto el formato del archivo como el algoritmo de cifrado y claves son exactamente las mismas a las descritas ahí. Además el formato de las fuentes es también el mismo.

En esta nueva generación no se apostó por cambiar el cifrado de textos y delegar toda la responsabilidad de dificultar la tarea de edición en el ofuscamiento de nombres de ficheros. El fichero está localizado en \textit{a/0/2/7}.

\subsubsection{Imágenes}
Al igual que sucede con los textos, tras repetir los pasos de la sección~\ref{sec:tr-pok-pearl-img} de imágenes se descubrió que se utiliza el mismo algoritmo de cifrado con las mismas claves. Se encontró sin embargo, una diferencia en la implementación pues en este caso se descifra empezando por el comienzo de los datos en lugar de por el final.

\subsubsection{Conclusión}

\begin{tabular}{p{0.4\textwidth}p{0.5\textwidth}}
Puntos fuertes & Puntos débiles \\
% Pros
\begin{itemize}
\item Los archivos están ofuscados por nombre y directorio.
\end{itemize} &

% Contras
\begin{itemize}
\item No todos los archivos están ofuscados como se ve en la siguiente apartado.
\item Se mantiene los mismos algoritmos y claves que en la generación anterior por lo que una vez encontrado los archivos se pueden reutilizar las mismas herramientas.
\end{itemize} \\
\end{tabular}

\subsection{Pokémon Blanco y Negro}
La sexta generación corresponde a los juegos \textit{Pokémon Blanco y Negro} para la \acl{NDS}.
Primero salieron en Japón a mediados de septiembre de 2010 y a principios de marzo de 2011 en América y Europa.
Esta vez, como curiosidad, el juego salió por primera vez dos días antes en Europa que en el resto de sitios.

De nuevo esta edición fue esperada por muchos seguidores que unido con el avance que hay en el mundo de la ingeniería inversa para la \acl{NDS} en estos años, facilitó la tarea de traducción no oficial~\cite{PokProj-BW1}.
No solo llegaron a salir traducciones al inglés si no también a otros idiomas como español.
Todas ellas se llevaron a cabo de forma transparente y colaborativa mediante GitHub\footnote{\url{https://github.com/projectpokemon/Pokemon-Black-White-Translation-Files}}.

\subsubsection{Archivos}
En la sexta generación decidieron optar de nuevo por ofuscar los nombres de las carpetas y archivos.
En este caso, se dio un paso más y se hizo sobre todos los archivos.
Sin bien, en el caso de \textit{Pokémon HeartGold y SoulSilver} fueron solo los archivos principales los ofuscados, en esta edición los únicos que no se procesaron fueron los de sonido y demo como se aprecia en la figura~\ref{fig:tr-blackheartfiles}.

\includefigure{fig:tr-blackheartfiles}{Comparación de carpetas entre Pokémon Blanco (izq.) y Pokémon HeartGold (der.)}{imgs/TR-BlackHeartFiles.png}

A pesar de usar internamente la misma forma de acceso a como se describió en el apartado de archivos de la sección~\ref{sec:tr-pok-heart-file}, los identificadores y por tanto localización de estos cambió.
Pasando de esta forma el archivo con los textos del juego a estar en \textit{a/0/0/2} en lugar de \textit{a/0/2/7} como sucedía en la edición anterior.

\subsubsection{Textos}
\label{sec:tr-pok-black-text}
En el apartado de protección a los textos, en las dos generaciones anteriores se utilizó un mismo algoritmo basado en un clave dinámica que se aplicaba con la operación XOR. En esta generación la filosofía del algoritmo se mantiene cambiando no obstante la forma de generación y actualización de la clave.
Esta se pudo obtener tras realizar el procedimiento descrito en el apartado textos de la sección~\ref{sec:tr-pok-pearl-text}.

La principal diferencia tras aplicar el método de investigación de cifrado fue ver que no se usaba una codificación propia si no UTF-16.
Esto facilitó la tarea, pues ya no es necesaria una búsqueda diferencial en la memoria RAM y por tanto crear \textit{software} adicional para investigar.
Se trata por tanto de la eliminación de un mecanismo fuerte a la hora de proteger datos que posiblemente estaba realizando en ediciones anteriores de casualidad.

La clave inicial usada para el texto se genera usando el número de bloque como variable, de forma que cada bloque comienza con una clave diferente. La operación es \verb!clave = (i + 3) * 0x2983!.
Tras aplicar esta clave sobre un valor de 16 bits cifrado (dos bytes), se actualiza desplazando los tres bits más significados a la posición menos significativa.
Esto se puede conseguir aplicando la siguiente serie de operaciones.

\begin{verbatim}
temp  = clave & 0x1FFF;             // Elimina los bits más significativos
clave = (temp << 3) | (clave >> 13) // y los añade al principio.
\end{verbatim}

Al desplazarse un número impar de veces, cada bit pasará de forma lineal sobre cada posición de la clave obteniéndose el máximo de permutaciones para una clave de 16 bits, es decir se usará a la hora de cifrar y descifrar 16 claves diferentes.

La estructura de datos se especifica en la tabla~\ref{tab:tr-blacktxt} donde se puede ver que la sección con la tabla de contenido no está cifrada a diferencia de cómo pasaba en ediciones anteriores.

\ctable[
    mincapwidth = 110 mm,
    footerwidth,
    caption = Especificación del formato de texto en Pokémon Blanco,
    label   = tab:tr-blacktxt,
    pos     = h,
]{ccl}{
    \tnote[a]{Se especifica solo la primera entrada.}
    \tnote[b]{Cada carácter es un valor de 16 bits.}
    \tnote[c]{Campo cifrado descrito en la sección~\ref{sec:tr-pok-black-text}.}
}{                                                                          \FL
    Posición      & Tamaño        & Descripción                             \ML
    \multicolumn{3}{c}{Cabecera}                                            \NN
    \texttt{0x00} & \texttt{0x02} & Constante: \texttt{0x01}                \NN
    \texttt{0x02} & \texttt{0x02} & Número de bloques de texto              \NN
    \texttt{0x04} & \texttt{0x04} & Tamaño de la sección de datos           \NN
    \texttt{0x08} & \texttt{0x04} & Constante: \texttt{0x00}                \NN
    \texttt{0x0C} & \texttt{0x04} & Tamaño de la cabecera                   \ML
    \multicolumn{3}{c}{Datos}                                               \NN
    \texttt{0x00} & \texttt{0x04} & Tamaño de la sección                    \NN
    \texttt{0x04} & \texttt{0x04} & Posición relativa a la sección\tmark[a] \NN
    \texttt{0x06} & \texttt{0x02} & Número de caracteres\tmark[a]\tmark[b]  \NN
    \texttt{0x08} & \texttt{0x02} & Desconocido\tmark[a]                    \ML
    \multicolumn{3}{c}{Texto\tmark[c]}                                      \LL
}

\subsubsection{Imágenes}
Las imágenes a diferencia de las pasadas generaciones no se cifraron.
En cambio, no se utiliza un formato estándar de codificación.
Si bien el formato para las paletas y datos de imagen si se reutiliza y sigue siendo estándar, existe un ficheros extras con una especificación nueva en este juego con la información necesaria para recomponer la imagen (figura~\ref{fig:tr-blackimg}).

\includefigure{fig:tr-blackimg}{Imágenes sin cifrar en Pokémon Negro.}{imgs/TR-BlackImg.png}

Esta forma de codificación, aunque pudiendo no ser específica para protegerlas ante modificaciones si no un requisito para animaciones, es más fuerte.
De esta forma los programas de ediciones genéricas creados para juegos de \acl{NDS} ya no son útiles y se necesita nuevos y específicos.
Esta tarea requiere de investigación de formatos y de programación, algo que toma más esfuerzo y tiempo que crear un decodificador como pasaba en las generaciones anteriores.

A pesar de ello, esta reconstrucción y edición de la imagen se podría llegar a cabo manualmente ya que el formato de los ficheros principales: paleta y datos de imagen, sigue siendo el estándar para juegos de la \acl{NDS}.

\subsubsection{Conclusión}

\begin{tabular}{p{0.4\textwidth}p{0.5\textwidth}}
Puntos fuertes & Puntos débiles \\
% Pros
\begin{itemize}
\item Los nombres de las carpetas y archivos están ofuscados.
\item Los textos están cifrados con un nuevo algoritmo y clave.
\item Las imágenes usan archivos extras con especificaciones nuevas para recomponerlas por lo que \textit{software} nuevo sería necesario.
\end{itemize} &

% Contras
\begin{itemize}
\item Los textos no usan una codificación propia.
\item Las imágenes no está cifradas.
\item Las imágenes usando el formato estándar para los archivos principales.
\end{itemize} \\
\end{tabular}

\subsection{Pokémon Conquest}
\textit{Pokémon Conquest} es un juego desarrollado por \textit{Tecmo Koei} y publicado en el año 2012 para la consola \acl{NDS}.
Este juego dista de la mecánica de la saga principal pues se trata de un género de combates por turnos y estrategia en lugar de RPG. Primero se distribuyó en Japón a mediados de marzo, y a pesar de que tardaron meses en confirmarlo, en junio y julio del mismo año se lanzó en América y Europa.

Esta falta de confirmación inicial hicieron incluso tres días antes del lanzamiento se formara un grupo de traducción no oficial con el objetivo de ofrecer una jugabilidad parcial lo más pronto posible~\cite{PokCheat-Conq}.
Esta traducción llegó a casi completarse al inglés en cuanto a la trama principal y listas de nombres.
Además surgieron a partir de esta varias a otros idiomas como italiano y alemán.

\subsubsection{Archivos}
En este juego no se han ofuscado los archivos y carpetas.
Todo está bien organizado y con nombres descriptivos.

\subsubsection{Textos}
\label{sec:tr-pok-conquest-text}
Los textos sí han cifrado y codificado con una protección mayor que en otras generaciones.
Para encontrar se buscó en primer lugar sobre la memoria RAM repitiendo el proceso explicado en el apartado textos de la sección~\ref{sec:tr-pok-pearl-text}.
Dado que se usa la codificación estándar SJIS se pudo encontrar directamente.

Una vez puesto el punto de interrupción se dio con el algoritmo que descodifica estos caracteres.
Con el objetivo de ahorra espacio y ofuscar el texto los archivos de textos tienen una codificación especial basada en caracteres de control y optimizada para caracteres japoneses.
Su sistema se basa en especificar solo un byte por carácter japonés en lugar de dos como dice SJIS.
El segundo carácter restante al estar comprendido entre \texttt{0x81--0x83} y es igual entre caracteres cercanos, se va predice mediante unos códigos de control.
Esta codificación está implementada en ambos sentidos en el proyecto AmbitionText\footnote{\url{http://subirelcodigo}}.
Destaca esta codificación pues no es sencilla de implementar y requiere mucho esfuerzo de creación de una herramienta que permita trabajar con ella.

Antes de esta parte de codificación, el texto se descifra.
El cifrado se basa en aplicar la clave ``\texttt{MsgLinker Ver1.00}'' sobre cada byte de texto.
A continuación se muestra la implementación en C\# para el cifrado y descifrado\footnote{\url{http://subirelcodigo}}.
El formato del fichero se especifica en la tabla~\ref{tab:tr-conquesttxt}.

\begin{verbatim}
string key = "MsgLinker Ver1.00";
for (int i = 0; i < data.Length; i++)
    data[i] ^= key[i % key.Length];
\end{verbatim}

\ctable[
    caption = Especificación del formato de texto en Pokémon Conquest,
    label   = tab:tr-conquesttxt,
    pos     = h,
]{ccl}{
    \tnote[a]{Se especifica solo la primera entrada.}
    \tnote[b]{Existen 33 bloques.}
    \tnote[c]{Campo cifrado descrito en la sección~\ref{sec:tr-pok-conquest-text}.}
}{                                                                          \FL
    Posición      & Tamaño        & Descripción                             \ML
    \multicolumn{3}{c}{\acl{TOC}\tmark[a]\tmark[b]}                         \NN
    \texttt{0x00} & \texttt{0x04} & Posición del bloque                     \NN
    \texttt{0x04} & \texttt{0x04} & Tamaño del bloque                       \ML
    \multicolumn{3}{c}{Bloques\tmark[c]}                                    \LL
}

\subsubsection{Imágenes}
Tanto los fondos como los \textit{sprites} del juego no vienen cifrados.
Sin embargo se usan formatos de ficheros nuevos, con codificaciones nuevas que supusieron un trabajo extra de creación de \textit{software}\footnote{\url{https://github.com/pleonex/tinke/tree/master/Plugins/PSL}}.

\subsubsection{Conclusión}

\begin{tabular}{p{0.4\textwidth}p{0.5\textwidth}}
Puntos fuertes & Puntos débiles \\
% Pros
\begin{itemize}
    \item Los textos vienen cifrados y codificados.
    \item La codificación es única para este juego.
    \item Nuevos formatos de imágenes que requieren nuevos programas.
\end{itemize} &

% Contras
\begin{itemize}
    \item Los archivos y carpetas no están ofuscados.
    \item Se usa una codificación final estándar.
    \item Las imágenes no están cifradas.
\end{itemize} \\
\end{tabular}

\section{Ninokuni y el Mago de las Tinieblas}
\textit{Ni no Kuni: Shikkoku no Madoshi} es el título original de un juego que solo llegó a Japón de la mano de \textit{Level-5} para la consola \acl{NDS} en 2010.
Desde su salida, debido a que el juego se distribuía junto a un libro físico, se confirmó que iba a poder salir de este país debido a los costes de producción y traducción que supondría el libro.

Es por ello, que a finales de 2011 un grupo denominado GradienWords\footnote{\url{http://gradienwords.com}} se formó con el objetivo de realizar una traducción altruista del juego.
Este proyecto terminó a finales de mayo de 2015 e incluye tanto el juego como una copia del libro en PDF traducida.
Con fecha de este trabajo este es el único proyecto de traducción de este juego que se ha finalizado, a pesar de que están en marcha varios al francés, inglés e italiano\footnote{\url{http://gbatemp.net/forums/nds-rom-hacking-and-translations.41/}}.

El juego se llegó a lanzar previamente en \acl{PS3} en varios idiomas incluyendo el español pero no llegó con la copia física del libro y tanto la mecánica del juego como la historia se cambiaron.

La protección encontrada en este juego muestra no se concentra en evitar una traducción, posiblemente porque la compañía sabía que ellos no lo iban a hacer, si no modificaciones del juego.
De esta forma se aprecia como los archivos que contienen parámetros como características de los monstruos, de ataque y batalla sí están cifrados.
Además de como se explicará el archivo de guardado también presenta un algoritmo de integridad.

\subsubsection{Archivos}
Los archivos y carpetas no están ofuscadas y está todo bien organizado y clasificado.

\subsubsection{Textos}
En cuanto al apartado de textos hay que distinguir de dos tipos: \textit{scripts} y nombres y descripciones.
Empezando por el último, este tipo de textos se encuentran en archivos que contienen las características de personajes, objetos y ataques y no solo el texto.
Con el objetivo de editar los parámetros que definen sus características y hacer una versión modificada del mismo con mayor, menor o una jugabilidad distinta estos ficheros se cifraron.
El cifrado es muy básico y pero eficaz ante personas que no entienden.
En la figura~\ref{fig:tr-nino-minitext} se puede ver como se repite el byte \texttt{0xFF} con frecuencia.
Esto da una pista del tipo de cifrado empleado pues probando a realizar una operación \verb!XOR 0xFF! o lo que es lo mismo \verb!NOT! se puede ver como todo queda descifrado.

\includefigure{fig:tr-nino-minitext}{Archivo cifrado (arr.) y descifrado (ab.) de Ninokuni y el Mago de las Tinieblas}{imgs/TR-NinoMiniText.png}

Respecto a los \textit{scripts} debido a sus requisitos técnicos para ejecutar todo tipo de comandos son complejos de investigar.
A día de hoy solo existe un \textit{software} no público desarrollado para la traducción al español que solo es capaz de editar los textos de los diálogos.
El formato está basado en parámetros a nivel de bits lo que hace inviable investigar el formato sin mirar las instrucciones máquinas del juego que lo procesan.

\subsubsection{Imágenes}
Las imágenes no están cifradas pero los archivos asociados a una imagen están comprimidos en un nuevo formato.
Son fáciles de extraer pero requiere nuevo \textit{software}\footnote{\url{https://github.com/pleonex/ninoimager}}.

\subsubsection{Integridad en archivos de guardado}
En este videojuego se ha estudiado adicionalmente los mecanismos de protección en el archivo con los datos de guardado.
Se trata de un fichero que en los cartuchos originales no se puede editar sin poseer \textit{hardware} adicional pero que en una \textit{flashcard} se trata de un fichero común, en este caso de 64 KB, y que por tanto es accesible y fácil de editar de forma no autorizada.

Para evitar esto mismo, en lugar de cifrar se ha apostado por implementar un algoritmo de integridad.
Para encontrarlo se buscó en la memoria RAM extraída con el emulador DeSmuME, los datos de este archivo.
Una vez localizada la parte de la memoria que contiene el archivo, se puso un punto de interrupción en los primeros bytes para conocer qué operaciones se realizan sobre los mismos.

En primer lugar se comprueba que el primer valor de 16 bits sea \texttt{0x0028} y que los últimos ocho bytes sean en hexadecimal \texttt{0B 3F A5 84 EC 32 9A 7D}.
A continuación sobre el resto de los datos, desde la posición \texttt{0x0002} hasta \texttt{0xFFE4} se calcula un hash usando el algoritmo SHA-1.
Para añadir seguridad e imposibilitar la edición sin conocer todos los detalles de la implementación, lo requiere mirar estas instrucciones máquinas, en la posición \texttt{0xC5EC} durante el cálculo del hash se escriben los bytes en hexadecimal \texttt{6E 6B 6E 6E} (en ASCII y \textit{low-endian} equivalen a las consonantes del nombre del juego `\textit{nnkn}').
Se trata de una clave que sin conocer ni su valor ni su posición sería imposible calcular un código SHA-1 válido.
Este hash se guarda en la posición \texttt{0xFFE4} del archivo de guardado y durante el inicio del juego se comprueba.
En caso de no ser válido el mensaje muestra un mensaje de error y borra todos los datos de la partida.

\includefigure{fig:tr-ninosaveinvalid}{Mensaje de error al detectar una partida modificada (izq.) y advertencia (der.).}{imgs/TR-NinoSaveInvalid.png}

\subsubsection{Conclusión}

\begin{tabular}{p{0.4\textwidth}p{0.5\textwidth}}
Puntos fuertes & Puntos débiles \\
% Pros
\begin{itemize}
    \item Formato complejo en los \textit{scripts}.
    \item Cifrado básico en algunos archivos de texto.
    \item Mecanismo de integridad en el archivo de guardado.
\end{itemize} &

% Contras
\begin{itemize}
    \item En general los archivos no están cifrados los archivos de texto.
    \item Las imágenes no están cifradas.
\end{itemize} \\
\end{tabular}

\section{Proyectos abandonados}
Para terminar se incluye un estudio sobre los proyectos de traducciones no oficiales que han sido abandonados con fecha de este trabajo y con sus respectivos motivos.
El estudio se ha centrado en juegos para la \acl{NDS} a partir de~\cite{GTemp-Aband} y~\cite{RH-Aband}.

El objetivo será el de mostrar las causas más frecuentes que como se verá en la mayoría de los casos fue por la confirmación de una localización al idioma de la traducción.

\subsubsection{Ausencia de \textit{software} de edición}
Surgidos por la falta de personal con conocimientos técnicos y de programación que puedan crear los programas necesarios de edición.
\begin{itemize}
\item WWII-Tank Battles (\acs{PS2}): Ausencia de descompresor de archivos.
\item Chi's Sweet Home: Chi ga Ouchi ni Yatte Kita! (\acs{NDS}): Ausencia de importador de imágenes.
\item Brave Fencer Musashi (\acs{PSX}): Ausencia de editor de textos.
\item Code Geass: Hangyaku no Lelouch (\acs{NDS}): Ausencia de editor de textos.
\item Custom Beat Battle Draglade 2 (\acs{NDS}): Ausencia de editor de textos.
\item Mobile Suit Gundam 00 (\acs{NDS}): Ausencia de editor de textos.
\item Super Robot Taisen OG Saga: Mugen No Frontier (\acs{NDS}): Ausencia de editor de textos.
\item Mysterious Dungeon: Shiren the Wanderer 2 (\acs{NDS}): Ausencia de editor de textos y de modificaciones técnicas necesarias sobre el juego.
\end{itemize}

\subsubsection{Problemas técnicos tras editar el juego}
Problemas surgidos durante la traducción que no se solucionaron debido a falta de conocimientos o abandono de soporte de quienes crearon las herramientas.
\begin{itemize}
\item Dai Kaijuu Monogatari (\acs{PSX}): Los programas usados para editar los textos causan bloqueos en el juego.
\item Resident Evil 2 (\acs{DC} y \acs{GC}): El compresor de archivos creado no funcionaba con todos.
\end{itemize}

\subsubsection{Abandono personal}
Causado en su mayoría por una falta de motivación y tiempo del equipo que lo llevaba a cabo.
\begin{itemize}
\item Professor Layton: London Life (\acs{NDS}).
\item Cross Treasures (\acs{NDS}).
\item Element Hunters (\acs{NDS}).
\item Hajime no Ippo The Fighting! DS (\acs{NDS}).
\item Naruto: Ninja Destiny 3 (\acs{NDS}).
\item Super Robot Wars K (\acs{NDS}).
\end{itemize}

\subsubsection{Traducción oficial}
Abandonos de proyectos por la llegada o confirmación de una traducción oficial.
\begin{itemize}
\item Final Fantasy: The 4 Warriors of Light (\acs{NDS}). Traducción inglesa.
\item Fire Emblem: Shadow Dragon (\acs{NDS}).
\item Glory of Heracles (\acs{NDS}).
\item Inazuma Eleven (\acs{NDS}).
\item Kindom Hearts 356/2 Days (\acs{NDS}).
\item Naruto: Ninja Destiny 2 (\acs{NDS}).
\item Nostalgia (\acs{NDS}).
\end{itemize}

Se puede ver que el problema más común está la falta de programas de edición de juegos concretos.
Para poder llevar a cabo esto hace falta unos conocimientos técnicos tanto de \textit{software} como de \textit{hardware} y de una larga experiencia.
Es por esto que a la hora de empezar un proyecto la parte técnica suele ser la más complicada de resolver y que en muchos casos nunca se llega a resolver del todo.

La segunda causa más frecuente es la confirmación de la llegada de una localización, suficiente motivo para parar el proyecto y no dañar los intereses de mercado de una empresa.
